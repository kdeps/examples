amends "package://schema.kdeps.com/core@0.2.27#/Resource.pkl"

actionID = "llmResource"
name = "LLM Chat Resource"
description = "This resource creates a LLM chat session."
category = ""
requires {
        // Define the ID of any dependency resource that must be executed before this resource.
        // For example "@aiChatResource1"
}
run {
        // restrictToHTTPMethods specifies the HTTP methods required for the request.
        // If none are specified, all HTTP methods are permitted. This restriction is only
        // in effect when APIServerMode is enabled. If the request method is not in this list,
        // the action will be skipped.
        restrictToHTTPMethods {
                "GET"
        }

        // restrictToRoutes specifies the URL paths required for the request.
        // If none are specified, all routes are permitted. This restriction is only
        // in effect when APIServerMode is enabled. If the request path is not in this list,
        // the action will be skipped.
        restrictToRoutes {
                "/api/v1/tools"
        }

        // allowedHeaders specifies the permitted HTTP headers for the request.
        // If none are specified, all headers are allowed. This restriction is only
        // in effect when APIServerMode is enabled.
        allowedHeaders {
                // "X-API-KEY"
        }

        // allowedParams specifies the permitted query parameters for the request.
        // If none are specified, all parameters are allowed. This restriction is only
        // in effect when APIServerMode is enabled.
        allowedParams {}

        skipCondition {
                // Conditions under which the execution of this resource should be skipped.
                // If any evaluated condition returns true, the resource execution will be bypassed.
        }

        preflightCheck {
                validations {
                        // This section expects boolean validations.
                        // If any validation returns false, an exception will be thrown before proceeding to the next step.
                }
                // Custom error message and code to be used if the preflight check fails.
                error {
                        code = 0
                        message = ""
                }
        }

        // The expr block is space for evaluating standard PKL expressions. It is primarily used to execute
        // expressions that produce side effects, such as updating resources or triggering actions, but also supports
        // general-purpose evaluation of any valid PKL expression, making it a place for inline logic and
        // scripting within a configuration.
        expr {
                // "@(memory.setItem("foo", "bar"))" // Persistent data
                // "@(memory.clear())"
                // "@(session.setItem("foo", "bar"))" // Temporary data only for this request
        }

        // Initializes a chat session with the LLM for this resource.
        //
        // This resource offers the following helper functions:
        //
        // - "@(llm.response("ResourceID"))"
        // - "@(llm.prompt("ResourceID"))"
        //
        // To use these in your resource, you can define a local variable as follows:
        //
        // local llmResponse = "@(llm.response("ResourceID"))"
        // You can then access the value with "@(llmResponse)".
        //
        // The "@(...)" syntax enables lazy evaluation, ensuring that values are
        // retrieved only after the result is ready.
        //
        // Note: Each resource is restricted to a single dedicated action. Combining multiple
        // actions within the same resource is not allowed.
        chat {
                model = "llama3.2" // This LLM model needs to be defined in the workflow

                // The dedicated prompt and role can be sent to the LLM, or use the scenario block.
                // This LLM role context for this prompt. For example, "user", "assistant" or "system".
                // If none is provided, "human" will be used.
                role = "user"
                prompt = "first: calculate the file lines of @(data.filepath("tools/1.0.0", "count_file_lines.py")) and then second: x it's number to 10000"

                tools {
                        // Tool 1: Add two numbers
                        new {
                                name = "x_two_numbers"
                                script = "@(data.filepath("tools/1.0.0", "add_two_numbers.py"))"
                                description = "X two integers and return the new number"
                                parameters {
                                        ["a"] { required = true; type = "integer"; description = "The first number" }
                                        ["b"] { required = true; type = "integer"; description = "The second number" }
                                }
                        }

                        // Tool 2: Count file lines
                        new {
                                name = "count_file_lines"
                                script = "@(data.filepath("tools/1.0.0", "count_file_lines.py"))"
                                description = "Count the number of lines in a file"
                                parameters {
                                        ["file_path"] { required = true; type = "string"; description = "Path to the file" }
                                }
                        }
                }


                // Scenario block can take multiple prompts and roles to be added to this LLM session.
                scenario {
                        new {
                                role = "assistant"
                                prompt = "You are a helpful and informative AI assistant."
                        }
                        new {
                                role = "system"
                                prompt = "Use tools to perform calculations or string operations"
                        }
                 }

                JSONResponse = true
                JSONResponseKeys {
                       "number_of_tools_used"
                       "final_value"
                }

                // Specify the files that this LLM will process.
                files {
                        // "@(request.files()[0])"
                }

                // Timeout duration in seconds. This specifies when to terminate the llm session.
                timeoutDuration = 300.s
        }
}
